## 第七章 确保Web安全的HTTPS
### 7.1 HTTP的缺点
* 通信使用明文（不加密），内容可能会被窃听  
* 不验证通信方的身份，因此有可能遭遇伪装  
* 无法证明报文的完整性，所以有可能也遭篡改  

这些问题不仅在HTTP上出现，其他未加密的协议中也会存在这类问题。

#### 7.1.1 通信使用明文可能会被窃听
HTTP本身不具备加密功能，无哦一无法做到对通信整体（使用HTTP协议通信的请求和响应的内容）
进行加密。即HTTP报文使用明文（指未经加密的报文）方式发送。

##### TCP/IP是可能被窃听的网络
即使已加密处理的通信也会被窥视通信内容，但可能让人无法破解报文信息的含义。

##### 加密处理防止被窃听
防止窃听保护信息的几种对策中，最为普及的就是加密技术。加密的对象可以有这么几个。

###### 通信的加密
HTTP协议中没有加密机制，但可以通过和SSL（Secure Socket Layer，安全套接层）或
TLS（Transport Layer Security，安全层传输协议），加密HTTP的通信内容。  
用SSL建立安全通信线路之后，就可以在这条线路上进行HTTP通信了。与SSL组合使用的
HTTP被称为HTTPS（HTTP Secure，超文本传输安全协议）或HTTP over SSL。

###### 内容的加密
客户端需要对HTTP报文进行加密处理后在发送请求。  
客户端和服务器端需要同时具备加密和解密机制，由于该方式不同于SSL或TLS将整个
通信线路加密处理，内容仍有被篡改的风险。

#### 7.1.2 不验证通信方的身份就可能遭遇伪装
HTTP协议中的请求和响应不会对通信方进行确认。
###### 任何人都可发起请求
任何人都可以发起请求，服务器只要接收到请求，不管对方是谁都会返回一个响应（未被服务器限制前提下）。  
会存在以下各种隐患。
* 无法确定请求发送至目标的Web服务器是否是按正式意图返回响应的那台服务器。有可能是已伪装的Web服务器。
* 无法确定响应返回到的客户端是否按真实意图接收响应的那个客户端。有可能是已伪装的客户端。
* 无法确定正在通信的对方是否具备访问权限。以为某些Web服务器上保存着重要的信息，
只想发给特定用户通信的权限。
* 无法判定请求是来自何方、出自谁手。
* 即使是无意义的请求也会照单全收。无法阻止海量请求下的DoS攻击（Denial of Service，拒绝服务攻击）。

###### 查明对手的证书
HTTP协议无法确定通信方。SSL不仅提供加密处理，而且使用了一种被称为证书的手段，
可用确定通信方。  
证书由值得信任的第三方机构颁发，用以证明服务器和客户端是实际存在的。另外，伪造证书
从技术角度是异常困难的事。所以只要能确认通信方（服务器或客户端）持有的证书，
即可判断通行方的真实意图。

#### 7.1.3 无法证明报文完整性，可能已遭篡改
完整性是指信息的准确度。

##### 接收到的内容可能有误
由于HTTP协议无法证明通信的报文完整性，没有任何办法确认发出的请求/响应和接收到的请求/响应时前后相同的。  
像这样请求或响应在传输途中，遭攻击者拦截并篡改内容的攻击称为中间人攻击（Man-in-the-Middle attack，MITM）。

##### 如何防止篡改
虽然有使用HTTP协议确定报文完整性的方法，但事实上并不便捷、可靠。其中常用的是MD5和
HSA-1等散列值娇艳的方法，以及用来确认文件的数字签名方法。  
提供文件下载服务的Web网站也会提供相应的以PGP（Pretty Good Privacy，完美隐私）创建
的数字签名及MD5算法生成的散列值。  
这些方法无法百分比确认结果正确。以为PGP和MD5本身被改写的话，用户是没有办法意识到的。  
为了有效防止这些弊端，有必要使用HTTPS。SSL提供认证和加密处理及摘要功能。仅靠HTTP
确保完整性是非常困难的，因此通过和其他协议组合使用来实现这个目标。

### 7.2 HTTP+加密+认证+完整性保护=HTTPS

#### 7.2.1 HTTP加上加密处理和认证以及完整性保护后即是HTTPS

#### 7.2.2 HPPTS是身披SSL外壳的HTTP
HTTPS并非是应用层的一种新协议。只是HTTP通信接口部分用SSL和TLS协议代替而已。  
通常，HTTP直接和TCP通信。当使用SSL时，则演变成先和SSL通信，再由SSL和TCP通信。  
在采用SSL后，HTTP就拥有的HTTPS的加密、证书和完整性保护这些功能。  
SSL是独立于HTTP的协议，所以不光是HTTP协议，其他运行在应用层的SMTP和Telnet等  
协议均可配合SSL协议使用。SSL可以说是当今世界应用最为广泛的网络安全技术。 

#### 7.2.3 相互交换密钥的公开密钥加密技术
SSL采用一种叫做公开密钥加密的加密处理方式。  
近代的加密方法中加密算法是公开的，而密钥确是保密的。通过该方式得以保持加密方法的安全性。  
加密和解密都会用到密钥。只要有密钥就能解密，如果密钥被攻击者获得，加密也就失去意义。 

##### 共享密钥加密的困境
加密和解密同用一个密钥的方式称为共享密钥加密，也被叫做对称密钥加密。  
已共享密钥方式加密时必须将密钥也发送给对方。发送密钥就有被窃听的风险，另外还得设法安全地
保管接收到的密钥。

##### 使用两把密钥的公开密钥加密
公开密钥加密使用一对非对称的密钥。一把叫做私有密钥，另一把叫做公开密钥。  
使用公开密钥加密方式，发送密文的一方使用对方的公开密钥进行加密处理，对方收到被加密
的信息后，再使用自己的私有密钥进行解密。利用这种方式，不需要发送用来解密的私有秘钥，
也不必担心密钥被攻击者窃听而盗走。

##### HTTPS采用混合加密机制
HTTPS采用共享密钥加密和公开密钥加密两者并用的混合加密机制。若密钥能够实现安全交换，
那么有可能会考虑仅使用公开密钥加密来通信。但是公开密钥加密与共享密钥加密相比，其处理速度要慢。  
所以应充分利用两者各自的优势，将多种方法组合起来用于通信。在交换密钥环节使用公开密钥
方式，之后的建立通信交换报文阶段则使用共享密钥加密方式。

#### 7.2.4 证明公开密钥正确性的证书
使用由数字证书认证机构和其他相关机关颁发的公开密钥证书。  
数字证书认证机构处于客户端与服务器双方都可信赖的第三方机构的立场上。  
首先，服务器的运营人员向数字证书认证机构提出公开密钥的申请。数字证书认证机构在
判明提出申请者的身份之后，会对已申请的公开密钥做数字签名，然后分配这个已签名的公开密钥，
并将该公开密钥放入公钥证书后绑定在一起。  
服务器会将这份由数字证书认证机构颁发的公钥证书发送给客户端，以进行公开密钥加密方式通信。
公钥证书也可以叫做数字证书或直接称为证书。  
接到证书的客户端可使用数字证书认证机构的公开密钥，对那张证书上的数字签名进行验证，
一旦验证通过，客户端便可明确两件事：一，认证服务器的公开密钥的是真实有效的数字证书
认证机构。而，服务器的公开密钥是值得信赖的。  
此处认证机关的公开密钥必须安全地转交给客户端。多数浏览器开发商发布版本时，会事先
在内部植入常用认证机关的公开密钥。

##### 可证明组织真实性的EV SSL证书
证书的一个作用是用来证明作为通信一方的服务器是否规范，另外一个作用是可确认对方
服务器背后运营的企业是否真实存在。拥有该特性的证书就是EV SSL证书（Extended Validation SSL Certificate）  

##### 用以确认客户端的客户端证书
HTTPS中还可以使用客户端证书。以客户端证书进行客户端认证，证明服务器正在通行的对方
始终是预料之内的客户端，其作用跟服务器证书如出一辙。  
现状是，安全性极高的认证机构可颁发客户端证书但近用于特殊用途的业务。比如那些可支撑客户端证书支出费用的业务。

##### 认证机构信誉第一
当伪造的证书被用作服务器伪装之时，用户根本无法察觉到。

##### 由自认证机构颁发的证书称为自签名证书
它无法消除伪装的可能性，就算加密通信，也不能排除正在和已经过伪装的假服务器保持通信。
值得信赖的第三方机构介入认证，才能让已植入在浏览器内的认证机构颁布的公开密钥发挥作用，
并借此证明服务器的真实性。

#### 7.2.5 HTTPS的安全通信机制
1. 客户端通过发送Client Hello报文开始SSL通信。报文中包含客户端支持的SSL的指定版本、
加密组件（Cipher Suite）列表（所使用的的加密算法及密钥长度等）。
2. 服务器可进行SSL通信时，会以ServerHello报文作为应答。和客户端一样，在报文中包含
SSL版本以及加密组件。服务器的加密组件内容是从接收到的客户端加密组件内筛选出来的。
3. 之后服务器发送Certificate报文。报文中包含公开密钥证书。
4. 最后服务器发送Server Hello Done报文通知客户端，最初阶段的SSL握手协商部分结束。
5. SSL第一次握手结束后，客户端以Client Key Exchange报文作为回应。报文中包含通信
加密中使用的一种被称为Pre-master secret的随机密码串。该报文已使用步骤3中的公开密钥加密。
6. 接着客户端继续发送Change Cipher Spec报文。该报文会1提示服务器，在此报文之后的
通信会采用Pre-master secret密钥加密。
7. 客户端发送Finished报文。该报文包含连接至今全部的整体校验值。这次握手协商是否
能够成功，要以服务器是否能够正确解密该报文作为判定标准。
8. 服务器同样发送Change Cipher Spec报文。
9. 服务器同样发送Finished报文。
10. 服务器和客户端的Finished报文交换完毕之后，SSL连接就算建立完成。当然，通信
会受到SSL的保护。从此处开始进行应用层协议的通信，即发送HTTP请求。
11. 应用层协议通信，即发送HTTP响应。
12. 最后由客户端断开连接。断开连接时，发送close_notify报文，之后在发送TCP FIN
报文来关闭TCP的通信。

##### SSL和TLS

##### SSL速度慢吗
SLL的慢分两种。一种是指通信慢。另一种是指由于大量消耗CPU及内存等资源，导致处理速度变慢。  
和使用HTTP相比，网络负载可能会变慢2到100倍。除去TCP连接、发送HTTP请求·响应以外，
还必须进行SSL通信，整体通行量处理增加。
SSL必须进行加密处理。在服务器和客户端都需要进行加密和解密的运算处理，比HTTP会更多
小号服务器和客户端的硬件资源，导致负载增强。