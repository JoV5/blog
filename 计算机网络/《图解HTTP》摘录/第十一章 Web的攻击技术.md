## 第十一章 Web的攻击技术
### 11.1 针对Web的攻击技术
简单的HTTP协议本身并不存在安全性问题，因此协议本身几乎不会成为攻击对象。应用HTTP
协议的服务器和客户端，以及运行在服务器上的Web应用等资源才是攻击目标。  

#### 11.1.1 HTTP不具备必要的安全功能
几乎现今所有的Web网站都会使用会话（session）管理、加密处理等安全性方面的功能，而
HTTP协议并不存在具备这些功能。  
从整体上看，HTTP就是一个通用的单纯协议机制。因此它具备较多优势，但安全性方面呈劣势。  
拿远程登录时会用到的SSH协议来说，SSH具备协议级别的认证及会话管理功能，HTTP协议则没有。
另外在架设SSH服务方面，任何人都可以轻易地创建安全等级高的服务，而HTTP即是已架设好
服务器，但若想提供服务器基础上的Web应用，很多情况下需要重新开发。  
因此，开发者需要自行设计并开发认证及会话管理功能来满足Web应用的安全。而自行设计意味着
会出现形形色色的实现。结果安全等级并不完备，隐藏着各种容易被攻击者滥用的安全漏洞的Bug。

#### 11.1.2 在客户端即可篡改请求
在Web应用中，从浏览器那接收到的HTTP请求的全部内容，都可以在客户端自由地变更、篡改。
所以Web应用可能会接收到与预期数据不相同的内容。  
在HTTP请求报文被加载攻击代码，就能发起对Web应用的攻击。通过URL查询字段或表单、HTTP
首部、Cookie等途径把攻击代码传入，若这时Web应用存在安全漏洞，那内部信息就会遭到窃取、
或被攻击者拿到管理权限。

#### 11.1.3 针对Web应用的攻击模式
对Web应用的攻击模式有以下两种。
* 主动攻击
* 被动攻击

##### 以服务器为目标的主动攻击
主动攻击是指攻击者通过直接访问Web应用，把攻击代码传入的攻击模式。由于该模式是直接针对
服务器上的资源进行攻击，因此攻击者需要能够访问到那些资源。  
主动攻击力具有代表性的攻击时SQL注入攻击和OS命令注入攻击。

##### 以服务器为目标的被动攻击
被动攻击（passive attack）是指利用圈套策略执行攻击代码的攻击模式。在被动攻击过程中，
攻击者不直接对目标Web应用访问发起攻击。  
被动攻击通常的攻击模式如下。
1. 攻击者诱使用户触发已设置好的陷阱，而陷阱会启动发送已嵌入攻击代码的HTTP请求。
2. 当用户不知不觉中招后，用户的浏览器或邮件客户端就会触发这个陷阱。
3. 中招后的用户浏览器会把含有攻击代码的HTTP请求发送给攻击目标的Web应用，运行攻击代码。
4. 执行攻击代码，存在安全漏洞的Web应用会成为攻击者的跳板，可能导致用户所持的Cookie等
个人信息被窃取，登录状态中的用户权限遭恶意滥用等后果。  
被动攻击模式中具有代表性的攻击是跨站脚本攻击和跨站点请求伪造。

###### 利用用户的身份攻击企业内部网络
利用被动攻击，可发起原本从互联网无法直接访问的企业内网等网络的攻击。只要用户踏入攻击者
预先设好的陷阱，在用户能够访问到的网络范围内，即使是企业内网也同样会受到攻击。  
好多企业内网依然可以连接到互联网，访问Web网站，或接受互联网发来的邮件。这样就可能给攻击
者以可乘之机，诱导用户触发陷阱后对企业内网发动攻击。

### 11.2 因输出值转义不完全引发的安全漏洞
实施Web应用的安全对策大致分为以下两部分。
* 客户端的验证
* Web应用端（服务器端）的验证
  * 输入值验证
  * 输出值转义 

#### 11.2.1 跨站脚本攻击
跨站脚本（Corss-Site Scripting，XSS）是指通过存在安全漏洞的Web网站注册用户的浏览器内
运行非法的HTML标签或JavaScript进行的一种攻击。动态创建HTML部分可能隐藏着安全漏洞。攻击
着编写脚本设下陷阱，用户在自己的浏览器上运行时，一不小心就会受到被动攻击。    
跨站脚本有可能造成以下邮箱。
* 利用虚假输入表单骗取用户个人信息。
* 利用脚本窃取用户的Cookie值，被害者在不知情的情况下，帮助攻击者发送恶意请求。
* 显示伪造的文章或图片。

##### 跨站脚本攻击案例
* 在动态生成HTML处发生
* XSS是攻击者利用预先设置的陷阱触发的被动攻击

##### 对用户Cookie的窃取攻击

#### 11.2.2 SQL注入攻击
##### 会执行非法SQL的SQL注入攻击
SQL注入（SQL Injection）是指针对Web应用使用的数据库，通过运行非法的SQL而产生攻击。该
安全隐患有可能引发极大的威胁，有时会直接导致个人信息及机密信息的泄露。

##### SQL注入攻击破坏SQL语句结构的案例

#### 11.2.3 OS命令注入攻击 
OS命令注入攻击（OS Command Injection）是指通过Web应用执行非法的操作系统命令达到攻击
的目的。只要能在调用Shell函数的地方就有存在被攻击的风险。

#### 11.2.4 HTTP首部注入攻击
HTTP首部注入攻击（HTTP Header Injection）是指攻击者通过在响应首部字段内插入换行，添加
任意响应首部或主体的一种攻击。输入被动攻击模式。  
向首部主体内添加内容的攻击称为HTTP响应截断攻击（HTTP Response Splitting Attack）。  
可能造成的一些影响。
* 设置任何Cookie信息
* 重定向至任意URL
* 显示任意的主体（HTTP响应截断攻击）

##### HTTP响应截断攻击
HTTP响应截断攻击是用在HTTP首部注入的一种攻击。攻击顺序相同，但是要将两个%0D%0A%0D%0A
并排插入字符串后发送。利用这两个连续的换行就可作出HTTP首部与主体分隔所需得空行，这样就
能显示伪造的主体，达到攻击的目的。  
利用这个攻击，已触发陷阱的用户浏览器会显示伪造的Web页面，在让用户输入自己的个人信息，可
达到和跨站脚本攻击相同的效果。  
另外，滥用HTTP/1.1中汇集多响应返回功能，会导致缓存服务器对任意内容进行缓存操作。这种攻击
称为缓存污染。使用该缓存服务器的用户，在浏览器遭受攻击的网站时，会不断地浏览被替换掉的Web网页。

#### 11.2.5 邮件首部注入攻击
邮件首部注入攻击（Mail Header Injection）是指Web应用中的邮件发送功能，攻击者通过向
邮件首部To或Subject内任意添加非法内容发起的攻击。利用存在安全漏洞的Web网站，可对任意
邮件地址发送广告邮件或病毒邮件。

#### 11.2.6 目录遍历
目录遍历（Directory Traversal）攻击是指对本无意公开的文件目录，通过非法截断其目录路径后，
达成访问目的的一种攻击。这种攻击有时也称为路径遍历（Path Traversal）攻击。  
固然存在输出值转义的问题，但应该关闭指定对任意文件名的访问。

#### 11.2.7 远程文件包含漏洞
远程文件包含漏洞（Remote File Inclusion）是指当部分脚本内容需要从其他文件读入是，攻击者
利用指定外部服务器的URL充当依赖文件，让脚本读取之后，就可运行任意脚本的一种攻击。

### 11.3 因设置或设计上的缺陷引发的安全漏洞

#### 11.3.1 强制浏览
强制浏览（Forced Browsing）安全漏洞是指，从安置在Web服务器的公开目录下的文件中，浏览那些
原本非自愿公开的文件。  
可能会造成以下影响。
* 泄露顾客的个人信息等重要情报
* 泄露原本需要具有访问权限的用户才可查看的信息内容
* 泄露未连接到外界的文件

##### 文件目录一览
通过制定文件目录名称，即可在文件一览中看到显示的文件名。

##### 容易被推测的文件名及目录名

##### 备份文件

##### 经认证才可显式的文件
直接通过URL访问原本必须经过认证才能在Web页面上使用的文件。

#### 11.3.2 不正确的错误消息处理
不正确的错误消息处理（Error Handling Vulnerability）的安全漏洞是指，Web应用的错误
信息包含对攻击者有用的信息。与Web应用有关的主要错误信息如下所示。
* Web应用抛出的错误信息
* 数据库等系统抛出的错误信息

Web应用不必再用的浏览器画面上展现详细的错误信息。对攻击者来说，详细的错误信息可能给以攻击提示。
##### Web应用抛出的错误信息

##### 数据库等系统抛出的错误信息 
主要集中在以下方面。
* PHP或ASP等脚本错误
* 数据库或中间件的错误
* Web服务器的错误

各系统应对详细的错误信息进行抑制设定，或使用自定义错误消息，以避免给攻击者启发。

#### 11.3.3 开放重定向
开放重定向（Open Redirect）是一种对指定的任意URL作重定向跳转功能。而对于此功能
相关联的安全漏洞指指定的重定向URL到某个具有恶意的Web网站，用户就会被诱导至那个网站。

### 11.4 因会话管理疏忽引发的安全漏洞
会话管理是用来管理用户状态的必备功能，但如果在会话管理上有所疏忽，就会导致用户的认证
状态被窃取等后果。

#### 11.4.1 会话劫持
会话劫持（Session Hijack）是指攻击者通过某种手段拿到了用户的会话ID，并非法使用此会话
ID伪装成用户，达到攻击的目的。  
具备认证功能的Web应用，会使用会话ID的会话管理机制，作为管理认证状态的主流方式。会话ID
中记录客户端的Cookie等信息，服务器端将会话ID与认证状态进行一对一匹配管理。  
下面列举了几种攻击者可获得会话ID的途径。
* 通过非正规的生成方法推测会话ID
* 通过窃听或XSS攻击盗取会话ID
* 通过会话固定攻击（Session Fixation）强行获取会话ID

攻击者得知Web网站存在可跨站攻击（XSS）的安全漏洞后，就设置好用JavaScript脚本调用
document.cookie以窃取Cookie信息的陷阱，一旦用户陷入陷阱（访问该脚本），攻击者就
能获取含有会话ID的Cookie。  
攻击者拿到用户的会话ID后，往自己的浏览器Cookie中设置该会话ID，即可伪装成会话ID遭窃
的用户，访问Web网站了。

#### 11.4.2 会话固定攻击
对以窃取目标会话ID为主动攻击手段的会话劫持而言，会话固定攻击（Session Fixation）攻击
会强制用户使用攻击者指定的会话ID，属于被动攻击。  
攻击者准备陷阱，县访问Web网站拿到会话ID。此刻，会话ID在服务器上的记录仍是（未认证）状态。  
攻击者设置好强制用户使用该会话ID的陷阱，并等待用户拿着这个会话ID前去认证。一旦用户触发陷
阱并完成认证，会话ID在服务器上的状态就会被记录下来。  
攻击者估计用户差不多已触发陷阱后，再利用之前这个会话ID访问网站。由于该会话ID已是（用户A
已认证）状态，于是攻击者作为用户A的身份顺利登陆网站。

#### 11.4.3 跨站点请求伪造
跨站点请求伪造（Corss-Site Request Forgeries，CSRF）攻击是指攻击者通过设置好的陷阱，
强制对已完成认证的用户进行非预期的个人信息或设定信息等状态更新，属于被动攻击。
可能造成以下影响。
* 利用已通过认证的用户权限更新设定信息等
* 利用已通过认证的用户权限购买商品
* 利用已通过认证的用户权限在留言板上发表言论

### 11.5 其他安全漏洞
#### 11.5.1 密码破解
密码破解攻击（Password Cracking）即算出密码，突破认证。不限于Web应用，还包括其他系统
（如FTP或SSH等）。  
密码破解有以下两种手段。
* 通过网络的密码试错
* 对已加密密码的破解（指攻击者入侵系统，已获得加密或散列处理的密码数据情况）

还有SQL注入攻击逃避认证，跨站脚本攻击窃取密码信息等方法。 

##### 通过网络进行密码试错
* 穷举法
* 字典攻击

> 利用别处泄露的ID*密码进行攻击  
>  字典攻击中有一种利用其它Web网站已泄露的ID及密码进行攻击。好多用户习惯在多个Web网站
使用同一套ID及密码。

##### 对已加密密码的破解
* 通过穷举法·字典进行类推
* 彩虹表
* 拿到密钥
* 加密算法的漏洞

#### 11.5.2 点击劫持
点击劫持（Clickjacking）是指利用透明的按钮或链接做成陷阱，覆盖在Web页面上。然后诱使用户
在不知情的情况下，点击那个链接访问内容的一种攻击手段。这种又行为称为界面伪装（UI Redressing）。

#### 11.5.3 Dos攻击
Dos攻击（Denial of Service attack）是一种让运行中的服务呈停止状态的攻击。诱使也叫做
服务停止或拒绝服务攻击。DoS攻击的对象不仅限于Web网站，还包括网络设备及服务器等。  
主要有以下两种DoS攻击方式。
* 几种利用访问请求造成资源过载，资源用尽的同时，实际上服务也呈停止状态 
* 通过攻击安全漏洞使服务停止

多台计算机发起的DoS攻击称为DDoS攻击（Distributed Denial of Service Attack）。
DDoS攻击通常利用那些感染病毒的计算机作为攻击者的跳板。

#### 11.5.4 后门程序
后门程序（Backdoor）是指开发设置的隐藏入口，可不按正常步骤使用受限功能。
通常后门程序分为以下3种类型。
* 开发阶段作为Debug调用的后门程序
* 开发者为了自身利益植入的后门程序
* 攻击者通过某种方式设置的后门程序  
可通过监视进程和通信的状态发现被植入的后门程序。但设定在Web应用中的后门程序，
由于和正常使用时区别不打，通常很难发现。





